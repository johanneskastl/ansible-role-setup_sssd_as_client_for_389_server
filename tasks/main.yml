---
# setup_sssd_as_client_for_389_server/tasks/main.yml

#
# /etc/openldap/ldap.conf
#
- name: 'Create /etc/openldap/ldap.conf'
  template:
    src: 'etc_openldap_ldap.conf.j2'
    dest: '/etc/openldap/ldap.conf'
    owner: 'root'
    group: 'root'
    mode: '0644'

#
# disable the nsdcd service on SUSE/openSUSE
#
- name: 'Stop and disable the nscd service'
  service:
    name: 'nscd'
    state: 'stopped'
    enabled: 'false'
  when: 'ansible_os_family == "Suse"'

#
# /etc/sssd/sssd.conf
#
- name: 'Create /etc/sssd/sssd.conf'
  template:
    src: 'sssd.conf_only_server_admins_group_allowed.j2'
    dest: '/etc/sssd/sssd.conf'
    owner: 'root'
    group: 'root'
    mode: '0600'
  notify:
    - 'Start the sssd service'
    - 'Restart the sssd service'

#
# nsswitch configuration
#

#- name: 'Prepare nsswitch configuration'
#  block:
#
#  - name: '/etc/nsswitch.conf: make sure sss is present in passwd line'
#    lineinfile:
#      path: '/etc/nsswitch.conf'
#      line: 'passwd: \1 sss \2'
#      regexp: '^passwd:\s([a-zA-Z]*)(\ssss)?(\s[a-zA-Z]*)'
#      state: 'present'
#      backrefs: 'yes'
#      backup: 'yes'
#
#  - name: '/etc/nsswitch.conf: make sure sss is present in group line'
#    lineinfile:
#      path: '/etc/nsswitch.conf'
#      line: 'group: \1 sss \2'
#      regexp: '^group:\s([a-zA-Z]*)(\ssss)?(\s[a-zA-Z]*)'
#      state: 'present'
#      backrefs: 'yes'
#      backup: 'yes'
#
#  - name: '/etc/nsswitch.conf: make sure sss is present in shadow line'
#    lineinfile:
#      path: '/etc/nsswitch.conf'
#      line: 'shadow: \1 sss \2'
#      regexp: '^shadow:\s([a-zA-Z]*)(\ssss)?(\s[a-zA-Z]*)'
#      state: 'present'
#      backrefs: 'yes'
#      backup: 'yes'

#
# sshd configuration
#
- name: 'Prepare the sshd configuration'
  block:

  - name: 'sshd_config: Make sure password authentication is enabled'
    lineinfile:
      path: '/etc/ssh/sshd_config'
      line: 'PasswordAuthentication yes'
      regexp: '^PasswordAuthentication'
      insertafter: '^#PasswordAuthentication'
      state: 'present'
    notify:
      - 'Restart the sshd service'

  - name: 'sshd_config: Make sure pubkey authentication is enabled'
    lineinfile:
      path: '/etc/ssh/sshd_config'
      line: 'PubkeyAuthentication yes'
      regexp: '^PubkeyAuthentication'
      insertafter: '^#PubkeyAuthentication'
      state: 'present'
    notify:
      - 'Restart the sshd service'

  - name: 'sshd_config: Make sure AuthorizedKeysCommand (needed for pubkey authentication) is enabled'
    lineinfile:
      path: '/etc/ssh/sshd_config'
      line: 'AuthorizedKeysCommand /usr/bin/sss_ssh_authorizedkeys'
      regexp: '^AuthorizedKeysCommand\ .*$'
      insertafter: '^#AuthorizedKeysCommand none'
      state: 'present'
    notify:
      - 'Restart the sshd service'

  - name: 'sshd_config: Make sure AuthorizedKeysCommandUser (needed for pubkey authentication) is enabled'
    lineinfile:
      path: '/etc/ssh/sshd_config'
      line: 'AuthorizedKeysCommandUser nobody'
      regexp: '^AuthorizedKeysCommandUser'
      insertafter: '^#AuthorizedKeysCommandUser'
      state: 'present'
    notify:
      - 'Restart the sshd service'

- include_tasks: 'pam_configuration_SUSE.yml'
  when: 'ansible_os_family == "Suse"'
  tags:
    - 'pam_on_suse'
